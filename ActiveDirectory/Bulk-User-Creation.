<#
.SYNOPSIS
    Bulk User Creation Tool for Active Directory
    
.DESCRIPTION
    Creates multiple Active Directory users from CSV file with automatic
    password generation, group assignment, and email notification.
    
.PARAMETER CSVPath
    Path to CSV file containing user information
    
.PARAMETER DefaultPassword
    Default password for new users (if not specified, generates random)
    
.PARAMETER SendWelcomeEmail
    Send welcome email to new users with credentials
    
.EXAMPLE
    .\Bulk-User-Creation.ps1 -CSVPath "C:\NewUsers.csv" -SendWelcomeEmail $true
    
.NOTES
    Author: Aykut YÄ±ldÄ±z
    Version: 1.0
    Date: 2024-11-21
    GitHub: https://github.com/infrawisetech/IT-Admin-Toolkit
    
    CSV Format Required:
    FirstName,LastName,Username,Email,Department,Title,Manager,Groups
#>

[CmdletBinding()]
param(
    [Parameter(Mandatory=$true)]
    [string]$CSVPath,
    
    [Parameter(Mandatory=$false)]
    [string]$DefaultPassword = "",
    
    [Parameter(Mandatory=$false)]
    [string]$OUPath = "OU=Users,DC=domain,DC=local",
    
    [Parameter(Mandatory=$false)]
    [bool]$SendWelcomeEmail = $true,
    
    [Parameter(Mandatory=$false)]
    [bool]$ForcePasswordChange = $true,
    
    [Parameter(Mandatory=$false)]
    [string]$LogPath = "C:\AD-BulkUsers"
)

#region Functions
function Write-BulkLog {
    param(
        [string]$Message,
        [string]$Level = "Info"
    )
    
    $timestamp = Get-Date -Format "yyyy-MM-dd HH:mm:ss"
    
    switch ($Level) {
        "Error" { Write-Host "[$timestamp] âŒ $Message" -ForegroundColor Red }
        "Warning" { Write-Host "[$timestamp] âš ï¸  $Message" -ForegroundColor Yellow }
        "Success" { Write-Host "[$timestamp] âœ… $Message" -ForegroundColor Green }
        default { Write-Host "[$timestamp] â„¹ï¸  $Message" -ForegroundColor Cyan }
    }
    
    if (-not (Test-Path $LogPath)) {
        New-Item -ItemType Directory -Path $LogPath -Force | Out-Null
    }
    
    $logFile = Join-Path $LogPath "BulkUserCreation_$(Get-Date -Format 'yyyy-MM-dd').log"
    "[$timestamp] [$Level] $Message" | Add-Content -Path $logFile
}

function New-RandomPassword {
    param(
        [int]$Length = 12
    )
    
    $uppercase = "ABCDEFGHKLMNPRSTUVWXYZ"
    $lowercase = "abcdefghkmnprstuvwxyz"
    $numbers = "23456789"
    $special = "!@#$%&*+"
    
    $password = ""
    $password += $uppercase[(Get-Random -Maximum $uppercase.Length)]
    $password += $lowercase[(Get-Random -Maximum $lowercase.Length)]
    $password += $numbers[(Get-Random -Maximum $numbers.Length)]
    $password += $special[(Get-Random -Maximum $special.Length)]
    
    $allChars = $uppercase + $lowercase + $numbers + $special
    
    for ($i = $password.Length; $i -lt $Length; $i++) {
        $password += $allChars[(Get-Random -Maximum $allChars.Length)]
    }
    
    return ($password.ToCharArray() | Get-Random -Count $Length) -join ''
}

function Test-Prerequisites {
    Write-BulkLog "Checking prerequisites..." "Info"
    
    # Check if AD module is available
    if (-not (Get-Module -ListAvailable -Name ActiveDirectory)) {
        Write-BulkLog "Active Directory module not found!" "Error"
        return $false
    }
    
    Import-Module ActiveDirectory
    
    # Check if CSV file exists
    if (-not (Test-Path $CSVPath)) {
        Write-BulkLog "CSV file not found: $CSVPath" "Error"
        return $false
    }
    
    # Check if OU exists
    try {
        Get-ADOrganizationalUnit -Identity $OUPath -ErrorAction Stop | Out-Null
    }
    catch {
        Write-BulkLog "OU not found: $OUPath" "Error"
        return $false
    }
    
    return $true
}

function New-BulkADUser {
    param(
        [PSCustomObject]$UserData,
        [string]$Password
    )
    
    try {
        # Check if user already exists
        $existingUser = Get-ADUser -Filter "SamAccountName -eq '$($UserData.Username)'" -ErrorAction SilentlyContinue
        
        if ($existingUser) {
            Write-BulkLog "User already exists: $($UserData.Username)" "Warning"
            return @{
                Success = $false
                Username = $UserData.Username
                Reason = "User already exists"
            }
        }
        
        # Prepare user properties
        $userParams = @{
            Name = "$($UserData.FirstName) $($UserData.LastName)"
            GivenName = $UserData.FirstName
            Surname = $UserData.LastName
            SamAccountName = $UserData.Username
            UserPrincipalName = "$($UserData.Username)@$((Get-ADDomain).DNSRoot)"
            EmailAddress = $UserData.Email
            Department = $UserData.Department
            Title = $UserData.Title
            Path = $OUPath
            AccountPassword = (ConvertTo-SecureString $Password -AsPlainText -Force)
            Enabled = $true
            ChangePasswordAtLogon = $ForcePasswordChange
        }
        
        # Add manager if specified
        if ($UserData.Manager) {
            $manager = Get-ADUser -Filter "SamAccountName -eq '$($UserData.Manager)'" -ErrorAction SilentlyContinue
            if ($manager) {
                $userParams.Manager = $manager.DistinguishedName
            }
        }
        
        # Create the user
        New-ADUser @userParams
        
        Write-BulkLog "User created successfully: $($UserData.Username)" "Success"
        
        # Add to groups if specified
        if ($UserData.Groups) {
            $groups = $UserData.Groups -split ';'
            foreach ($group in $groups) {
                try {
                    Add-ADGroupMember -Identity $group.Trim() -Members $UserData.Username
                    Write-BulkLog "Added $($UserData.Username) to group: $group" "Success"
                }
                catch {
                    Write-BulkLog "Failed to add to group $group : $_" "Warning"
                }
            }
        }
        
        return @{
            Success = $true
            Username = $UserData.Username
            Password = $Password
            Email = $UserData.Email
            FullName = "$($UserData.FirstName) $($UserData.LastName)"
        }
    }
    catch {
        Write-BulkLog "Failed to create user $($UserData.Username): $_" "Error"
        return @{
            Success = $false
            Username = $UserData.Username
            Reason = $_.Exception.Message
        }
    }
}

function Send-WelcomeEmail {
    param(
        [hashtable]$UserInfo
    )
    
    $emailTemplate = @"
<html>
<body style="font-family: Arial, sans-serif;">
    <h2>Welcome to the Organization!</h2>
    <p>Dear $($UserInfo.FullName),</p>
    <p>Your Active Directory account has been created. Below are your login credentials:</p>
    <ul>
        <li><strong>Username:</strong> $($UserInfo.Username)</li>
        <li><strong>Temporary Password:</strong> $($UserInfo.Password)</li>
        <li><strong>Email:</strong> $($UserInfo.Email)</li>
    </ul>
    <p><strong>Important:</strong> You will be required to change your password on first login.</p>
    <p>If you have any questions, please contact the IT department.</p>
    <br>
    <p>Best regards,<br>IT Department</p>
</body>
</html>
"@
    
    try {
        Send-MailMessage -To $UserInfo.Email `
                        -From "it-noreply@company.com" `
                        -Subject "Welcome - Your Account Has Been Created" `
                        -Body $emailTemplate `
                        -BodyAsHtml `
                        -SmtpServer "smtp.company.local"
        
        Write-BulkLog "Welcome email sent to $($UserInfo.Email)" "Success"
    }
    catch {
        Write-BulkLog "Failed to send email to $($UserInfo.Email): $_" "Warning"
    }
}

function Export-CreationReport {
    param(
        [array]$Results
    )
    
    $htmlReport = @"
<!DOCTYPE html>
<html>
<head>
    <title>Bulk User Creation Report - $(Get-Date -Format 'yyyy-MM-dd HH:mm')</title>
    <style>
        body { font-family: 'Segoe UI', Arial; background: #f5f5f5; margin: 20px; }
        .container { max-width: 1200px; margin: 0 auto; background: white; padding: 30px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        h1 { color: #2c3e50; border-bottom: 3px solid #3498db; padding-bottom: 10px; }
        .summary { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin: 30px 0; }
        .stat-box { background: #f8f9fa; padding: 20px; border-radius: 8px; text-align: center; }
        .stat-value { font-size: 2.5em; font-weight: bold; color: #2c3e50; }
        .stat-label { color: #7f8c8d; margin-top: 5px; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th { background: #3498db; color: white; padding: 12px; text-align: left; }
        td { padding: 10px; border-bottom: 1px solid #ecf0f1; }
        tr:hover { background: #f8f9fa; }
        .success { color: #27ae60; font-weight: bold; }
        .failed { color: #e74c3c; font-weight: bold; }
        .footer { text-align: center; margin-top: 30px; color: #7f8c8d; font-size: 0.9em; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸš€ Bulk User Creation Report</h1>
        <p>Generated by Aykut YÄ±ldÄ±z | $(Get-Date -Format 'dddd, MMMM dd, yyyy HH:mm:ss')</p>
        
        <div class="summary">
            <div class="stat-box">
                <div class="stat-value">$($Results.Count)</div>
                <div class="stat-label">Total Processed</div>
            </div>
            <div class="stat-box">
                <div class="stat-value" style="color: #27ae60;">$(($Results | Where-Object Success -eq $true).Count)</div>
                <div class="stat-label">Successfully Created</div>
            </div>
            <div class="stat-box">
                <div class="stat-value" style="color: #e74c3c;">$(($Results | Where-Object Success -eq $false).Count)</div>
                <div class="stat-label">Failed</div>
            </div>
        </div>
        
        <h2>User Creation Details</h2>
        <table>
            <thead>
                <tr>
                    <th>Username</th>
                    <th>Full Name</th>
                    <th>Email</th>
                    <th>Status</th>
                    <th>Details</th>
                </tr>
            </thead>
            <tbody>
"@

    foreach ($result in $Results) {
        $statusClass = if ($result.Success) { "success" } else { "failed" }
        $status = if ($result.Success) { "Created" } else { "Failed" }
        $details = if ($result.Success) { "Password set, groups assigned" } else { $result.Reason }
        
        $htmlReport += @"
                <tr>
                    <td>$($result.Username)</td>
                    <td>$($result.FullName)</td>
                    <td>$($result.Email)</td>
                    <td class="$statusClass">$status</td>
                    <td>$details</td>
                </tr>
"@
    }

    $htmlReport += @"
            </tbody>
        </table>
        
        <div class="footer">
            <p>PowerShell Bulk User Creation Tool v1.0 | IT Admin Toolkit</p>
        </div>
    </div>
</body>
</html>
"@

    $reportFile = Join-Path $LogPath "BulkUserReport_$(Get-Date -Format 'yyyyMMdd_HHmmss').html"
    $htmlReport | Out-File -FilePath $reportFile -Encoding UTF8
    
    # Also export credentials to secure CSV
    $credFile = Join-Path $LogPath "UserCredentials_$(Get-Date -Format 'yyyyMMdd_HHmmss').csv"
    $Results | Where-Object Success -eq $true | 
               Select-Object Username, Password, Email, FullName |
               Export-Csv -Path $credFile -NoTypeInformation
    
    Write-BulkLog "Report saved to: $reportFile" "Success"
    Write-BulkLog "Credentials saved to: $credFile" "Success"
    
    return $reportFile
}
#endregion

#region Main Script
function Main {
    Write-Host @"
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘         Bulk User Creation Tool for AD v1.0                â•‘
â•‘         PowerShell Automation by Aykut YÄ±ldÄ±z             â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
"@ -ForegroundColor Cyan

    # Check prerequisites
    if (-not (Test-Prerequisites)) {
        Write-BulkLog "Prerequisites check failed. Exiting..." "Error"
        return
    }
    
    # Import CSV
    Write-BulkLog "Importing CSV file: $CSVPath" "Info"
    try {
        $users = Import-Csv -Path $CSVPath
        Write-BulkLog "Found $($users.Count) users to create" "Info"
    }
    catch {
        Write-BulkLog "Failed to import CSV: $_" "Error"
        return
    }
    
    # Validate CSV columns
    $requiredColumns = @("FirstName", "LastName", "Username", "Email", "Department", "Title")
    $csvColumns = $users[0].PSObject.Properties.Name
    
    foreach ($col in $requiredColumns) {
        if ($col -notin $csvColumns) {
            Write-BulkLog "Missing required column: $col" "Error"
            return
        }
    }
    
    # Process users
    $results = @()
    $createdCount = 0
    $failedCount = 0
    
    Write-Host ""
    Write-Host "Processing Users..." -ForegroundColor Yellow
    Write-Host "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”" -ForegroundColor Gray
    
    foreach ($user in $users) {
        Write-Host ""
        Write-BulkLog "Processing: $($user.Username)" "Info"
        
        # Generate or use default password
        $password = if ($DefaultPassword) { $DefaultPassword } else { New-RandomPassword }
        
        # Create user
        $result = New-BulkADUser -UserData $user -Password $password
        
        if ($result.Success) {
            $createdCount++
            
            # Send welcome email if enabled
            if ($SendWelcomeEmail -and $result.Email) {
                Send-WelcomeEmail -UserInfo $result
            }
        } else {
            $failedCount++
        }
        
        $results += $result
    }
    
    # Generate report
    Write-Host ""
    Write-BulkLog "Generating report..." "Info"
    $reportFile = Export-CreationReport -Results $results
    
    # Summary
    Write-Host ""
    Write-Host "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•" -ForegroundColor Green
    Write-Host "         BULK USER CREATION COMPLETE" -ForegroundColor Green
    Write-Host "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•" -ForegroundColor Green
    Write-Host ""
    Write-Host "ğŸ“Š Summary:" -ForegroundColor Yellow
    Write-Host "   âœ… Successfully Created: $createdCount" -ForegroundColor Green
    Write-Host "   âŒ Failed: $failedCount" -ForegroundColor Red
    Write-Host ""
    Write-Host "ğŸ“ Reports saved to: $LogPath" -ForegroundColor Cyan
    
    # Open report
    Start-Process $reportFile
}

# Run the script
Main
#endregion
